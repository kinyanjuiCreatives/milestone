{% extends 'base.html' %}

{% block title %}Enter Marks - Exam Management System{% endblock %}

{% block content %}
<!-- Previous HTML content remains exactly the same -->
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const studentsByCourse = JSON.parse('{{ students_data_json|escapejs }}');
    
    // Load Students Button
    document.getElementById('loadStudentsBtn').addEventListener('click', function() {
        const courseSelect = document.getElementById('course');
        const newCourseInput = document.getElementById('new_course');
        const unitSelect = document.getElementById('unit');
        const newUnitInput = document.getElementById('new_unit');
        const school = document.getElementById('school').value;
        const term = document.getElementById('term').value;
        const level = document.getElementById('level').value;
        const year = document.getElementById('year').value;
        
        // Determine course value
        let courseValue = courseSelect.value;
        if (!courseValue && newCourseInput.value.trim()) {
            courseValue = newCourseInput.value.trim();
        }
        
        // Determine unit value
        let unitValue = unitSelect.value;
        if (!unitValue && newUnitInput.value.trim()) {
            unitValue = newUnitInput.value.trim();
        }
        
        if (!courseValue || !school || !unitValue || !term || !level || !year) {
            alert('Please fill in all configuration fields first.');
            return;
        }
        
        // Copy values to hidden fields
        document.getElementById('course_hidden').value = courseValue;
        document.getElementById('school_hidden').value = school;
        document.getElementById('unit_hidden').value = unitValue;
        document.getElementById('term_hidden').value = term;
        document.getElementById('level_hidden').value = level;
        document.getElementById('year_hidden').value = year;
        
        // Load students for the selected course
        loadStudentsForCourse(courseValue);
        
        // Show the table section
        document.getElementById('studentsTableSection').style.display = 'block';
    });
    
    // Form validation before submission
    document.getElementById('marksEntryForm').addEventListener('submit', function(e) {
        const courseValue = document.getElementById('course_hidden').value;
        const unitValue = document.getElementById('unit_hidden').value;
        const termValue = document.getElementById('term_hidden').value;
        const yearValue = document.getElementById('year_hidden').value;
        
        if (!courseValue || !unitValue || !termValue || !yearValue) {
            e.preventDefault();
            alert('Please configure all settings (course, unit, term, year) before saving marks.');
            return;
        }
        
        // Check if there are any students in the table
        const tbody = document.getElementById('studentsTableBody');
        if (tbody.children.length === 0) {
            e.preventDefault();
            alert('No students found. Please load students or add new students before saving.');
            return;
        }
    });
    
    function loadStudentsForCourse(courseId) {
        const tbody = document.getElementById('studentsTableBody');
        tbody.innerHTML = '';
        
        try {
            // Find students for this course
            let courseStudents = [];
            
            if (studentsByCourse[courseId]) {
                courseStudents = studentsByCourse[courseId];
            } else {
                // Try to find by course name if courseId is a string (new course)
                for (const [id, students] of Object.entries(studentsByCourse)) {
                    if (students.length > 0 && students[0].course_name && 
                        students[0].course_name.toLowerCase() === courseId.toString().toLowerCase()) {
                        courseStudents = students;
                        break;
                    }
                }
            }
            
            if (courseStudents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No students found for this course.</td></tr>';
                return;
            }
            
            // Get current configuration values
            const unitValue = document.getElementById('unit_hidden').value || '';
            const termValue = document.getElementById('term_hidden').value || '';
            const yearValue = document.getElementById('year_hidden').value || '';
            
            // If we have all configuration values, fetch existing marks
            if (unitValue && termValue && yearValue) {
                fetchExistingMarks(courseId, unitValue, termValue, yearValue, courseStudents, tbody);
            } else {
                // Create table rows without existing marks
                createStudentRows(courseStudents, tbody, {});
            }
        } catch (error) {
            console.error('Error loading students:', error);
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading students. Please try again.</td></tr>';
        }
    }

    function fetchExistingMarks(courseId, unitValue, termValue, yearValue, courseStudents, tbody) {
        const params = new URLSearchParams({
            course_id: courseId,
            unit_id: unitValue,
            term: termValue,
            year: yearValue
        });
        
        fetch(`/get-existing-marks/?${params}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error fetching existing marks:', data.error);
                    createStudentRows(courseStudents, tbody, {});
                } else {
                    createStudentRows(courseStudents, tbody, data.existing_marks);
                }
            })
            .catch(error => {
                console.error('Error fetching existing marks:', error);
                createStudentRows(courseStudents, tbody, {});
            });
    }
    
    function createStudentRows(courseStudents, tbody, existingMarks) {
        courseStudents.forEach((student, index) => {
            const marks = existingMarks[student.id] || {};
            const hasExistingMarks = marks.cat1_score || marks.cat2_score || marks.end_term_score;
            
            const row = document.createElement('tr');
            if (hasExistingMarks) {
                row.className = 'table-warning';
                row.title = 'This student already has marks for this unit/term/year';
            }
            
            const rowContent = `
                <td>${index + 1}</td>
                <td>
                    ${student.name}
                    ${hasExistingMarks ? '<i class="fas fa-check-circle text-success ms-2" title="Existing marks found"></i>' : ''}
                </td>
                <td>${student.registration_number}</td>
                <td>
                    <input type="number" name="cat1_${student.id}" class="form-control cat1-input" 
                           min="0" max="30" step="0.01" placeholder="0-30" value="${marks.cat1_score || ''}">
                </td>
                <td>
                    <input type="number" name="cat2_${student.id}" class="form-control cat2-input" 
                           min="0" max="30" step="0.01" placeholder="0-30" value="${marks.cat2_score || ''}">
                </td>
                <td>
                    <input type="number" name="endterm_${student.id}" class="form-control endterm-input" 
                           min="0" max="70" step="0.01" placeholder="0-70" value="${marks.end_term_score || ''}">
                </td>
                <td>
                    <span class="total-score">${calculateTotal(marks.cat1_score, marks.cat2_score, marks.end_term_score)}</span>
                </td>
            `;
            row.innerHTML = rowContent;
            tbody.appendChild(row);
        });
        
        // Add event listeners for real-time calculation
        addCalculationListeners();
    }
    
    function calculateTotal(cat1, cat2, endterm) {
        const cat1Val = parseFloat(cat1) || 0;
        const cat2Val = parseFloat(cat2) || 0;
        const endtermVal = parseFloat(endterm) || 0;
        const catAverage = (cat1Val + cat2Val) / 2;
        const total = catAverage + endtermVal;
        return total.toFixed(2);
    }
    
    function addCalculationListeners() {
        const rows = document.querySelectorAll('#studentsTableBody tr');
        rows.forEach(row => {
            const cat1Input = row.querySelector('.cat1-input');
            const cat2Input = row.querySelector('.cat2-input');
            const endtermInput = row.querySelector('.endterm-input');
            const totalSpan = row.querySelector('.total-score');
            
            if (cat1Input && cat2Input && endtermInput && totalSpan) {
                const calculateTotal = () => {
                    const cat1 = parseFloat(cat1Input.value) || 0;
                    const cat2 = parseFloat(cat2Input.value) || 0;
                    const endterm = parseFloat(endtermInput.value) || 0;
                    const catAverage = (cat1 + cat2) / 2;
                    const total = catAverage + endterm;
                    totalSpan.textContent = total.toFixed(2);
                };
                
                cat1Input.addEventListener('input', calculateTotal);
                cat2Input.addEventListener('input', calculateTotal);
                endtermInput.addEventListener('input', calculateTotal);
            }
        });
    }
});
</script>
{% endblock %}
